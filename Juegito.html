<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>Jugador con marco</title>
<style>
:root{
  --bg:#1a0a1f;
  --accent:#ff4fc1;
}

@keyframes playerHitBlink {
  0%   { filter: drop-shadow(0 0 4px white) brightness(2) saturate(3) hue-rotate(-30deg); }
  50%  { filter: drop-shadow(0 0 4px white) brightness(1) saturate(1); }
  100% { filter: drop-shadow(0 0 4px white) brightness(2) saturate(3) hue-rotate(-30deg); }
}

html, body {
  margin:0;
  width:100%;
  height:100%;
  position:fixed;
  overflow:hidden;
  background: linear-gradient(180deg, #1a0a1f 0%, #2a0f2f 100%);
}

/* ---- MARCO DEL JUEGO ---- */
#game-frame{
  
  position:absolute;
  top:5%;
  left:50%;
  transform:translateX(-50%);
  width:80vw;
  height:80vh;
  background-image:url('juegofondito.png');
  background-size:100% 100%;
  background-position:center;
  background-repeat:no-repeat;
  border:12px solid #ff4fc1;
  box-shadow:0 0 25px #ff4fc1, inset 0 0 25px #ff4fc1;
  border-radius:25px;
  overflow:hidden;
  z-index:5;

  

}


#game-frame::after{
  content:"";
  position:absolute;
  inset:0;
  background: rgba(0,0,0,0.5); /* ← 50% de opacidad */
  pointer-events:none;
  z-index:1;
}

#game-area{
  position:absolute;
  width:100%;
  height:100%;
  overflow:hidden;
}

#player{
  width:80px;
  height:80px;
  background-image: url('SpriteFACEDOWN.png');
  background-size: cover;
  background-position: center;
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%, -50%);
  transform-origin: bottom center;
  z-index:10;
  transition: transform 0.1s ease-out, background-image 0.1s ease-out;
  filter: drop-shadow(0 0 4px white);
}
/* ---- JOYSTICK IZQUIERDA ---- */
#joy-base{
  width:120px;
  height:120px;
  background:rgba(255,255,255,0.1);
  border:2px solid #ff4fc1;
  border-radius:50%;
  position:fixed;
  bottom:20px;
  left:20px;
  transform:none;
  z-index:20;
  touch-action:none;
}

#joy-stick{
  width:60px;
  height:60px;
  background:#ff4fc1;
  border-radius:50%;
  position:absolute;
  top:30px;
  left:30px;
  z-index:21;
  touch-action:none;
}

/* ---- BOTÓN DERECHA ---- */
#shoot-btn{
  position:fixed;
  bottom:20px;
  right:20px;
  padding:15px 25px;
  background:#ff4fc1;
  border:none;
  border-radius:10px;
  color:white;
  font-weight:bold;
  font-size:16px;
  cursor:pointer;
  z-index:30;
  user-select:none;
}

.bullet{
  width:40px;
  height:40px;
  position:absolute;
  background-image:url('Corazon.png');
  background-size:cover;
  background-position:center;
  pointer-events:none;
  z-index:15;
  filter: drop-shadow(0 0 4px white);
}
.npc {
  width:60px;
  height:60px;
  position:absolute;
  background-image: url('npctite.png');
  background-size: cover;
  background-position: center;
  pointer-events:none;
  z-index:8; /* Debajo del player pero encima del fondo */
  filter: drop-shadow(0 0 4px white) hue-rotate(-20deg) saturate(1.2); /* tinte rojizo */
  transition: filter 0.3s ease;
}


.particle{
  width:6px;
  height:6px;
  position:absolute;
  background:#ff4fc1;
  border-radius:50%;
  pointer-events:none;
  opacity:0.8;
  z-index:14;
}
/* ---- ENEMIGO MAITI ---- */
.enemy {
  width:70px;
  height:70px;
  position:absolute;
  background-image:url('maiti.png');
  background-size:cover;
  background-position:center;
  pointer-events:none;
  z-index:9;
  filter: drop-shadow(0 0 4px red);
}

/* ---- VIDA ---- */
#life-bar{
  position:fixed;
  top:60px; /* bajé la vida para que no choque con el contador (antes top:20px) */
  right:20px;
  color:white;
  font-size:20px;
  font-weight:bold;
  z-index:60;
  font-family: 'Press Start 2P', Arial, sans-serif;
  user-select:none;
}


</style>
</head>
<body>
<!-- PANTALLA DE VICTORIA -->
<div id="victory" style="
  position:fixed;
  inset:0;
  background:black;
  opacity:0;
  pointer-events:none;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  z-index:400;
  transition: opacity 1s ease;
">
  <img id="victory-img" src="Victoria.png" style="
    max-width:80%;
    max-height:80%;
    object-fit:contain;
    opacity:0;
    transition: opacity 1s ease;
  ">
  <button id="continue-btn" style="
    margin-top:20px;
    padding:15px 25px;
    background:#ff4fc1;
    border:none;
    border-radius:10px;
    color:white;
    font-weight:bold;
    cursor:pointer;
    font-size:18px;
    opacity:0;
    transition: opacity 1s ease;
  ">Seguir</button>
</div>


">
  <img id="victory-img" src="Victoria.png" style="
    max-width:80%;
    max-height:80%;
    object-fit:contain; /* Mantiene proporción sin estirar */
    display:none;
  ">
  <button id="continue-btn" style="
    margin-top:20px;
    padding:15px 25px;
    background:#ff4fc1;
    border:none;
    border-radius:10px;
    color:white;
    font-weight:bold;
    cursor:pointer;
    font-size:18px;
    display:none;
  ">Seguir</button>
</div>
<audio id="victory-sound" src="victoria.wav"></audio>

<div id="game-frame">
  <!-- PANTALLA INICIAL -->
<div id="start-screen" style="
  position:absolute;
  inset:0;
  background:black;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  text-align:center;
  color:white;
  font-family:'Press Start 2P', Arial, sans-serif;
  font-size:20px;
  padding:20px;
  z-index:300;
">
  <div style="max-width:80%; margin-bottom:30px;">
    shainita estaba apunto de enfrentarse al ejercito de Ms, una extraña raza de mamaguebas fekas,<br>
 tenia q salvar a los daniels...
  </div>

  <button id="start-btn" style="
    padding:15px 25px;
    background:#ff4fc1;
    border:none;
    border-radius:10px;
    color:white;
    font-weight:bold;
    cursor:pointer;
    font-size:18px;
  ">Iniciar</button>
</div>

  <div id="game-area">
  <div id="counter" style="
  position:fixed;
  top:20px;
  left:20px;
  color:white;
  font-size:20px;
  font-weight:bold;
  display:flex;
  align-items:center;
  gap:10px;
  z-index:50;
  user-select:none;
  -webkit-user-select:none;
  -moz-user-select:none;
  -ms-user-select:none;
  font-family: 'Press Start 2P', Arial, sans-serif;
">
  <img src="npcfeli.png" style="width:30px; height:30px;">
  <span>daniels salvado jeje: 0</span>
</div>

<div id="life-bar">Vida de shainita: 30</div>

<!-- PANTALLA DE GAME OVER -->
<div id="gameover" style="
  position:fixed;
  inset:0;
  background:black;
  opacity:0;
  pointer-events:none;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  color:white;
  font-family:'Press Start 2P', Arial;
  font-size:30px;
  transition:opacity 1s ease;
  z-index:200;
">
  <div id="go-text" style="margin-bottom:20px;">Perdiste miamor</div>
  <button id="retry-btn" style="
    padding:15px 25px;
    background:#ff4fc1;
    border:none;
    border-radius:10px;
    color:white;
    font-weight:bold;
    cursor:pointer;
    font-size:18px;
  ">Reintental</button>
</div>



    <div id="player"></div>
  </div>
</div>

<div id="joy-base"><div id="joy-stick"></div></div>
<button id="shoot-btn">Dispara el amol</button>

<script>
  const victory = document.getElementById("victory");
const continueBtn = document.getElementById("continue-btn");

continueBtn.addEventListener("click", () => {
    window.location.href = "Main.html";
});


   // ---------------- VIDA ----------------
let life = 30;
const lifeText = document.getElementById("life-bar");
let lastDamageTime = 0;

// ---------------- GAME OVER ----------------
const gameover = document.getElementById("gameover");
const retryBtn = document.getElementById("retry-btn");

retryBtn.addEventListener("click", ()=>{
  location.reload();
});

// --- Obtener lista de enemigos ---
function getEnemies(){
  return Array.from(document.querySelectorAll('.enemy'));
}

// --- Separación entre enemigos ---
function applySeparation(enemy, ex, ey){
  const enemies = getEnemies();
  let repelX = 0;
  let repelY = 0;

  const desiredDist = 50; // distancia mínima entre enemigos

  enemies.forEach(other=>{
    if(other === enemy) return;

    const ox = parseFloat(other.style.left);
    const oy = parseFloat(other.style.top);

    const dx = ex - ox;
    const dy = ey - oy;
    const dist = Math.sqrt(dx*dx + dy*dy);

    if(dist < desiredDist && dist > 0){
      const force = (desiredDist - dist) / desiredDist;
      repelX += (dx/dist) * force * 1.3;
      repelY += (dy/dist) * force * 1.3;
    }
  });

  return {x: repelX, y: repelY};
}


// ---------------- ENEMIGO (MAITI) ----------------
function spawnEnemy() {
  const enemy = document.createElement('div');
  enemy.className = 'enemy';
  enemy.dataset.alive = "true"; // indicador de que está vivo
  area.appendChild(enemy);

  const start = getRandomOutsidePosition();
  enemy.style.left = start.x + 'px';
  enemy.style.top = start.y + 'px';

  let enemyFrame; // aquí guardamos la referencia de requestAnimationFrame

  function moveEnemy() {
    // si el enemigo murió, no hacemos nada
    if (enemy.dataset.alive === "false" || life <= 0) return;

    let ex = parseFloat(enemy.style.left);
    let ey = parseFloat(enemy.style.top);
    const dx = px - ex;
    const dy = py - ey;
    const dist = Math.sqrt(dx*dx + dy*dy);
    const stopDist = 40;

    if (dist > stopDist) {
      const speed = 1.2;
      let vx = dx / dist * speed;
      let vy = dy / dist * speed;

      const sep = applySeparation(enemy, ex, ey);
      vx += sep.x;
      vy += sep.y;

      ex += vx;
      ey += vy;
      enemy.style.left = ex + "px";
      enemy.style.top = ey + "px";
    } else {
      const now = Date.now();
      if (now - lastDamageTime >= 1000) {
        life -= 10;
        if (life < 0) life = 0;
        lifeText.textContent = `Vida de shainita: ${life}`;
        lastDamageTime = now;
        playerDamageBlink();
      }
      if (life <= 0) {
        showGameOver();
        return;
      }
    }

    enemyFrame = requestAnimationFrame(moveEnemy);
  }

  moveEnemy();

  // función para “matar” al enemigo
  enemy.die = function() {
    enemy.dataset.alive = "false";       // marcar como muerto
    cancelAnimationFrame(enemyFrame);     // detener loop
    enemy.style.transition = "opacity 0.5s ease";
    enemy.style.opacity = 0;
    setTimeout(() => { enemy.remove(); }, 500); // eliminar del DOM
  }
}

// --- EFECTO DE DAÑO EN EL PLAYER ---
let damageBlinkTimeout = null;
function playerDamageBlink(){
  const p = document.getElementById("player");

  // Evitar que se acumule el efecto
  if(damageBlinkTimeout) clearTimeout(damageBlinkTimeout);

  // Rojo fuerte tipo "hit"
  p.style.filter = "drop-shadow(0 0 4px white) brightness(1.3) saturate(2) hue-rotate(-20deg)";

  // Parpadeo rápido
  p.style.animation = "playerHitBlink 0.25s linear 2";

  damageBlinkTimeout = setTimeout(()=>{
    p.style.filter = "drop-shadow(0 0 4px white)"; // vuelve al normal
    p.style.animation = "none";
    damageBlinkTimeout = null;
  }, 300);
}

let gameStarted = false;

function stopProcesses() {
    clearInterval(npcInterval);
    clearInterval(enemyInterval);
}

const startBtn = document.getElementById('start-btn');
const startScreen = document.getElementById('start-screen');

startBtn.addEventListener('click', () => {
    startScreen.style.display = 'none'; // Oculta la pantalla de inicio
    startProcesses();                    // Inicia NPCs y enemigos
    gameStarted = true;                  // Marca que el juego comenzó
});

let enemyInterval;
let npcInterval;

function startProcesses() {
    // Spawn enemigo cada 6 segundos
    enemyInterval = setInterval(spawnEnemy, 6000);

    // Spawn NPC cada 5 segundos
    npcInterval = setInterval(spawnNPC, 5000);
}
// ----------- GAME OVER -------------
function showGameOver(){
  gameover.style.pointerEvents = "all";
  gameover.style.opacity = "1";
}

let savedCount = 0;
const maxSaved = 15; // máximo a salvar
const counterText = document.querySelector('#counter span');
counterText.textContent = `daniels salvado jeje: ${savedCount}/${maxSaved}`; // inicializa como 0/20


const frame = document.getElementById("game-frame");
const area = document.getElementById("game-area");
const base = document.getElementById("joy-base");
const stick = document.getElementById("joy-stick");
const player = document.getElementById("player");
const shootBtn = document.getElementById("shoot-btn");

let px = 0;
let py = 0;

function centerPlayer(){
  const r = area.getBoundingClientRect();
  px = r.width/2;
  py = r.height/2;
  player.style.left = px + "px";
  player.style.top = py + "px";
}
centerPlayer();

function checkCollision(bullet, npc){
  const bx = parseFloat(bullet.style.left);
  const by = parseFloat(bullet.style.top);
  const bw = bullet.offsetWidth;
  const bh = bullet.offsetHeight;

  const nx = parseFloat(npc.style.left);
  const ny = parseFloat(npc.style.top);
  const nw = npc.offsetWidth;
  const nh = npc.offsetHeight;

  return !(bx + bw < nx || bx > nx + nw || by + bh < ny || by > ny + nh);
}


let input = {x:0, y:0};
let lastAngle = Math.PI/2;
let joystickPointerId = null;
function getPos(e){ return {x:e.clientX, y:e.clientY}; }

base.addEventListener("pointerdown", e=>{
  joystickPointerId = e.pointerId;
  const rect = base.getBoundingClientRect();
  moveJoystick(e, { x: rect.left+rect.width/2, y: rect.top+rect.height/2 });
});
window.addEventListener("pointermove", e=>{
  if(e.pointerId !== joystickPointerId) return;
  const rect = base.getBoundingClientRect();
  moveJoystick(e, { x: rect.left+rect.width/2, y: rect.top+rect.height/2 });
});
window.addEventListener("pointerup", e=>{
  if(e.pointerId !== joystickPointerId) return;
  joystickPointerId = null;
  input = {x:0, y:0};
  stick.style.left = "30px";
  stick.style.top  = "30px";
});

function moveJoystick(e, center){
  let pos = getPos(e);
  let dx = pos.x - center.x;
  let dy = pos.y - center.y;
  const maxDist = 50;
  const dist = Math.sqrt(dx*dx + dy*dy) || 1;
  let nx = dx/dist;
  let ny = dy/dist;
  let intensity = Math.min(dist/maxDist,1);
  input = {x:nx*intensity, y:ny*intensity};
  lastAngle = Math.atan2(input.y, input.x);

  const clamp = Math.min(dist,maxDist);
  stick.style.left = (nx*clamp + 30) + "px";
  stick.style.top  = (ny*clamp + 30) + "px";
}

function loop(){
  const speed = 2.5;
  px += input.x*speed;
  py += input.y*speed;

  const r = area.getBoundingClientRect();
  if(px < 0) px = 0;
  if(py < 0) py = 0;
  if(px > r.width) px = r.width;
  if(py > r.height) py = r.height;

  player.style.left = px + "px";
  player.style.top  = py + "px";

  let scaleY = 1;
  if(input.x!==0 || input.y!==0) scaleY = 0.9 + 0.05*Math.sin(Date.now()/50);

  const angle = Math.atan2(input.y,input.x);
  const th = Math.PI/6;
  if(input.x>0 && Math.abs(angle)<th){
    player.style.backgroundImage = "url('SpriteFACERIGHT.png')";
    player.style.transform = `translate(-50%,-50%) scaleY(${scaleY}) scaleX(1)`;
  } else if(input.x<0 && Math.abs(angle)>Math.PI-th){
    player.style.backgroundImage = "url('SpriteFACERIGHT.png')";
    player.style.transform = `translate(-50%,-50%) scaleY(${scaleY}) scaleX(-1)`;
  } else {
    player.style.backgroundImage = "url('SpriteFACEDOWN.png')";
    player.style.transform = `translate(-50%,-50%) scaleY(${scaleY}) scaleX(1)`;
  }

  requestAnimationFrame(loop);
}
loop();

function shoot(){
  const bullet = document.createElement('div');
  bullet.className = 'bullet';
  bullet.style.left = px + 'px';
  bullet.style.top = py + 'px';
  area.appendChild(bullet);

  const speed = 7;
  const angle = lastAngle;
  let rot = 0;
  const trail = [];

  function updateBullet(){
    let bx = parseFloat(bullet.style.left);
    let by = parseFloat(bullet.style.top);
    bx += Math.cos(angle)*speed;
    by += Math.sin(angle)*speed;
    bullet.style.left = bx + 'px';
    bullet.style.top = by + 'px';

    rot += 10;
    bullet.style.transform = `rotate(${rot}deg)`;

    // Partículas de la bala
    const p = document.createElement('div');
    p.className = 'particle';
    p.style.left = bx + (Math.random()-0.5)*10 + 'px';
    p.style.top = by + (Math.random()-0.5)*10 + 'px';
    area.appendChild(p);
    trail.push(p);

    trail.forEach((t,i)=>{
      t.style.opacity -= 0.05;
      if(t.style.opacity<=0){ t.remove(); trail.splice(i,1);} 
    });

    // --- CHEQUEAR COLISION CON NPCS ---
    const npcs = document.querySelectorAll('.npc');
    for(const npc of npcs){
        if(checkCollision(bullet, npc)){
            if(!npc.dataset.saved && savedCount < maxSaved){
                npc.dataset.saved = 'true';
                savedCount++;
                counterText.textContent = `daniels salvado jeje: ${savedCount}/${maxSaved}`;
if(savedCount >= maxSaved){
    // Activar pantalla de victoria
    victory.style.pointerEvents = "all";
    victory.style.opacity = "1";

    const victoryImg = document.getElementById("victory-img");
    const continueBtn = document.getElementById("continue-btn");

    // Mostrar con fade
    setTimeout(() => {
      victoryImg.style.opacity = "1";
      continueBtn.style.opacity = "1";
    }, 100); // pequeño delay para que el browser registre la transición

    document.getElementById("victory-sound").play();

    clearInterval(npcInterval);
    clearInterval(enemyInterval);
    document.querySelectorAll('.npc, .enemy').forEach(e => e.remove());
}




            }
            // Efecto visual tipo “feliz”
            npc.style.backgroundImage = "url('npcfeli.png')";
            npc.style.filter = 'drop-shadow(0 0 4px white) hue-rotate(80deg) saturate(4.2)';
            bullet.remove();
            return;
        }
    }

    // --- CHEQUEAR COLISION CON ENEMIGOS ---
    const enemies = getEnemies();
    for(const enemy of enemies){
        const ex = parseFloat(enemy.style.left);
        const ey = parseFloat(enemy.style.top);
        const ew = enemy.offsetWidth;
        const eh = enemy.offsetHeight;

        if(!(bx + bullet.offsetWidth < ex || bx > ex + ew || by + bullet.offsetHeight < ey || by > ey + eh)){
            if(enemy.die) enemy.die();  // Mata al enemigo completamente
            bullet.remove();
            return;
        }
    }

    // Revisar si la bala salió del área
    const r = area.getBoundingClientRect();
    if(bx<0 || bx>r.width || by<0 || by>r.height){
      bullet.remove();
      return;
    }

    requestAnimationFrame(updateBullet);
  }

  updateBullet();
}

// Disparar con el botón
shootBtn.addEventListener('pointerdown', shoot);

// Disparar con la tecla F
window.addEventListener('keydown', (e) => {
  if(e.key.toLowerCase() === 'f'){
    shoot();
  }
});

function getRandomOutsidePosition() {
  const r = area.getBoundingClientRect();
  const side = Math.floor(Math.random()*4); // 0=top,1=right,2=bottom,3=left
  let x, y;

  switch(side){
    case 0: // arriba
      x = Math.random()*r.width;
      y = -60;
      break;
    case 1: // derecha
      x = r.width + 60;
      y = Math.random()*r.height;
      break;
    case 2: // abajo
      x = Math.random()*r.width;
      y = r.height + 60;
      break;
    case 3: // izquierda
      x = -60;
      y = Math.random()*r.height;
      break;
  }

  return {x,y};
}

function getRandomInsidePosition() {
  const r = area.getBoundingClientRect();
  const x = Math.random()*r.width;
  const y = Math.random()*r.height;
  return {x,y};
}
window.addEventListener('keydown', (e) => {
    if(e.key === '7'){
        savedCount = maxSaved; // 18 o 20 según quieras
        counterText.textContent = `daniels salvado jeje: ${savedCount}/${maxSaved}`;
    }
});


function spawnNPC() {
  const npc = document.createElement('div');
  npc.className = 'npc';
  
  // Posición inicial fuera del marco
  const start = getRandomOutsidePosition();
  npc.style.left = start.x + 'px';
  npc.style.top  = start.y + 'px';
  
  area.appendChild(npc);

  // Posición final: cruzando todo el marco
  const r = area.getBoundingClientRect();
  let end = {x:0, y:0};

  // Si empieza arriba o abajo, lo mandamos al lado opuesto horizontal aleatorio
  if(start.y < 0) { // arriba
    end.y = r.height + 60; // abajo
    end.x = Math.random()*r.width;
  } else if(start.y > r.height) { // abajo
    end.y = -60; // arriba
    end.x = Math.random()*r.width;
  } else if(start.x < 0) { // izquierda
    end.x = r.width + 60; // derecha
    end.y = Math.random()*r.height;
  } else if(start.x > r.width) { // derecha
    end.x = -60; // izquierda
    end.y = Math.random()*r.height;
  }

  // Velocidad en px por frame
const speed = 1.5 + Math.random()*1.5; // entre 3 y 6 px por frame



 function move() {
  let nx = parseFloat(npc.style.left);
  let ny = parseFloat(npc.style.top);

  const dx = end.x - nx;
  const dy = end.y - ny;
  const dist = Math.sqrt(dx*dx + dy*dy);

  if(dist < speed){
    // Si el NPC no fue salvado, restamos 1 al contador
    if(!npc.dataset.saved){
      savedCount--;
      counterText.textContent = `daniels salvado jeje: ${savedCount}/${maxSaved}`;
    }

    npc.remove();
    return;
  }

  nx += dx/dist*speed;
  ny += dy/dist*speed;

  npc.style.left = nx + 'px';
  npc.style.top = ny + 'px';

  requestAnimationFrame(move);
}

  move();
}


window.addEventListener('resize', centerPlayer);
</script>

</body>
</html>
